<html>
<head>
    <script lang="javascript">
        var lastMsgId = -1;
        function request(method, path, params) {
            var xhr = new XMLHttpRequest();
            path += "?" + params
            xhr.open(method, encodeURI(path), true);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                if (this.readyState != 4 || this.status != 200) {
                    return;
                }
                var chatRoomMessages = document.getElementById('chatRoomMessages');
                lastMsgId = this.responseText.substr(0,this.responseText.indexOf(":"))
                chatRoomMessages.value += this.responseText.substr(this.responseText.indexOf(":")+1)
                chatRoomMessages.scrollTop = chatRoomMessages.scrollHeight;
            };
            xhr.send();
        }
        function getMessage() {
            var chatRoom = document.getElementById("currentChatRoom").value
            var xhr = new XMLHttpRequest();
            var path = "/chatRooms/" + chatRoom + "?lastMsgId=" + lastMsgId;
            xhr.open("get", encodeURI(path), true);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                if (this.readyState != 4 || this.status != 200) {
                    return;
                }
                var chatRoomMessages = document.getElementById('chatRoomMessages');
                lastMsgId = this.responseText.substr(0,this.responseText.indexOf(":"))
                chatRoomMessages.value += this.responseText.substr(this.responseText.indexOf(":")+1)
                chatRoomMessages.scrollTop = chatRoomMessages.scrollHeight;
            };
            xhr.send();
        }
        function sendMessage() {
            var currentChatRoomContent = document.getElementById('currentChatRoom').value;
            var inputMessageContent = document.getElementById('inputMessage').value;
            var params = "inputMessage=" + inputMessageContent + "&lastMsgId=" + lastMsgId;
            request('post', '/chatRooms/' + currentChatRoomContent,params)
        }
        function reloadChatRooms() {
            var xhr = new XMLHttpRequest();
            var path = "chatRooms"
            xhr.open('get', encodeURI(path), true);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                if (this.readyState != 4 || this.status != 200) {
                    return;
                }
                var chatRoomNames = this.responseText.split(',')
                var chatRoomNameElmt = document.getElementById('chatRoomName');
                while (chatRoomNameElmt.options.length > 0) {
                    chatRoomNameElmt.remove(0);
                }
                chatRoomNames.forEach(function(chatRoomNameString) {
                    if (chatRoomNameString.trim().length > 0) {
                        var option = document.createElement("option");
                        option.text = chatRoomNameString;
                        chatRoomNameElmt.add(option);
                    }
                })
            };
            xhr.send();
        }
        function createChatRoom() {
            lastMsgId = 0;
            document.getElementById('chatRoomMessages').value = '';
            var newChatRoomNameContent = document.getElementById('newChatRoomName').value;
            document.getElementById('currentChatRoom').value = newChatRoomNameContent;
            request('put', '/chatRooms/' + newChatRoomNameContent, "lastMsgId=0")
            reloadChatRooms();
        }
        function loadChatRoom() {
            lastMsgId = 0;
            document.getElementById('chatRoomMessages').value = '';
            var chatRoomNameElmt = document.getElementById('chatRoomName');
            var chatRoomNameContent = chatRoomNameElmt.options[chatRoomNameElmt.selectedIndex].text;
            document.getElementById('currentChatRoom').value = chatRoomNameContent;
            request('get', '/chatRooms/' + chatRoomNameContent, "lastMsgId=0")
        }
    </script>
</head>
<body onload="setInterval(getMessage, 3000);setInterval(reloadChatRooms, 3000)">
<div>
    <textarea rows="15" cols="120" id="chatRoomMessages" style="resize: none;">chat messages</textarea>
</div>
<div>
    Current ChatRoom:
    <input type="text" readonly="true" id="currentChatRoom" value="default" /><br>
    Send a message:
    <input type="text" id="inputMessage" value="messages from chatRoom" />
    <input type="button" value="Send" onclick="sendMessage()" />
    <input type="button" value="Get" onclick="getMessage()" /><br>
    Create a ChatRoom:<input type="text" id="newChatRoomName" />
    <input type="button" value="Create ChatRoom" onclick="createChatRoom()" /><br>
    Select a ChatRoom:
    <select id="chatRoomName">
        <option value="default">default</option>
    </select>
    <input type="button" value="Load Chat Room" onclick="loadChatRoom()" /><br>
</div>
</body>
</html>